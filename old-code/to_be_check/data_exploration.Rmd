---
title: "test"
author: "Saras Windecker"
date: "24 February 2017"
output: html_notebook
---

# Data Exploration
## Step 1: Questions
Do plant traits and initial plant chemical composition impact relative rates of decomposition of wetland plant species, and does the effect of traits on decomposition rate differ with hydrologic treatment? Do plant trait and initial plant chemical composition have a greater impact than hydrologic treatment?

## Step 3: Conduct data exploration
Load my packages
```{r packages}
library(ggplot2)
library(lme4)
library(smatr)
```

Read in and prep data
```{r prep data, echo = F}
n <- read.table('../munge/inundated_data.txt')

```

Plot allometric relationship between traits
$y = \gamma x^{\beta}$
$log y = log\gamma + \beta logx$
```{r smatr on trait covariates, correlation matrix}
# still waiting on S
n <- n[!n$fSpecies == 'Phragmites australis',]

plot(n$tLDMC, n$tCN)
sma(n$tCN ~ n$tLDMC)

plot(n$tSLA, n$tLDMC)
sma(n$tLDMC ~ n$tSLA)

plot(n$tSLA, n$tCN)
sma(n$tCN ~ n$tSLA)

panel.cor <- function(x, y, digits = 2, cex.cor, ...) {
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  
  # correlation coefficient
  r <- cor(x, y)
  txt <- format(c(r, 0.123456789), digits = digits)[1]
  txt <- paste("r= ", txt, sep = "")
  text(0.5, 0.6, txt)

  # p-value calculation
  p <- cor.test(x, y)$p.value
  txt2 <- format(c(p, 0.123456789), digits = digits)[1]
  txt2 <- paste("p= ", txt2, sep = "")
  if(p<0.01) txt2 <- paste("p= ", "<0.01", sep = "")
  text(0.5, 0.4, txt2)
}

pairs(n[,c('CN', 'SLA', 'LDMC', 'pcomp_1', 'pcomp_2', 'pcomp_3')], upper.panel = panel.cor)
```


```{r first plots, echo = F}
# add zero weight amounts for plotting
bzero <- unique(m[,c(1,2,4,5)])
bzero$baggie <- 0
bzero$pre_weight <- 6
bzero$removal_date <- NA
bzero$weeks <- 0
bzero$days <- 0
bzero$removal_weight <- 6
bzero <- bzero[,c(1,2,5,3,4,6:10)]
m_1 <- rbind(m, bzero)
# add categorisation groupings

m_2 <- m_1
m_2$fDays <- as.factor(paste(m_2$days, 'd'))
m_2$spdays <- as.factor(paste(m_2$fSpecies, m_2$fDays))
ggplot(m_2[m_2$fTreatment == 'inundated',], aes(days, mass_rem/mass_init, col = fSpecies)) +
  geom_boxplot(aes(group = spdays)) + 
  theme(legend.position = 'none')

```

# Data Exploration
## 1. Outliers?
```{r outliers, echo = F}
inun <- m_1[m_1$fTreatment == 'inundated',]
dotchart(inun$mass_rem, main= "Mass Remaining - Inundated")
```

data is uneven. many more points concentrated up between .6 and .9
variable data is even more uneven.

```{r, echo = F}

species_list <- unique(inun$species_code)
for (i in seq_along(species_list)) {
  df = subset(inun, species_code == species_list[i])
  species <- ggplot(df, aes(days, mass_rem)) +
    geom_point() +
    ggtitle(species_list[i])
  png(paste0("../output/inundated/", species_list[i], ".png"), 4, 4, "in", res = 100)
  print(species)
  dev.off()
}

```
no obvious outliers within each species' trends

```{r fig.height = 10, fig.width= 9.5}
png('../output/d_spp_LDMC.png')
par(mfrow = c(5, 6), mar = c(3, 4, 1, 1))
inun_1 <- transform(inun, species = reorder(species, LDMC)) 
species_ldmc <- ggplot(inun_1, aes(days, mass_rem, colour = LDMC)) +
  geom_point() + 
  scale_colour_gradient(guide=guide_colourbar(reverse = TRUE), 
                         low="#5EB7F8", high="#1A334B")
species_ldmc + facet_wrap( ~ species, ncol = 5 )
dev.off()
```

```{r fig.height = 10, fig.width= 9.5}
png('../output/d_spp_CN.png')
par(mfrow = c(5, 6), mar = c(3, 4, 1, 1))
inun_2 <- transform(inun, species = reorder(species, CN)) 
species_cn <- ggplot(inun_2, aes(days, mass_rem, colour = CN)) +
  geom_point() + 
  scale_colour_gradient(guide=guide_colourbar(reverse = TRUE), 
                         low="#5EB7F8", high="#1A334B")
species_cn + facet_wrap( ~ species, ncol = 5 )
dev.off()
```



```{r fig.height = 10, fig.width= 9.5}
png('../output/d_spp_SLA.png')
par(mfrow = c(5, 6), mar = c(3, 4, 1, 1))
inun_3 <- transform(inun, species = reorder(species, SLA)) 
species_cn <- ggplot(inun_2, aes(days, mass_rem, colour = SLA)) +
  geom_point() + 
  scale_colour_gradient(guide=guide_colourbar(reverse = TRUE), 
                         low="#5EB7F8", high="#1A334B")
species_cn + facet_wrap( ~ species, ncol = 5 )
dev.off()
```


# 2. Homogeneity
conditional boxplots
```{r, echo = F}
require(gridExtra)
p1 <- ggplot(inun_1, aes(fSpecies, mass_rem, colour = fSpecies)) +
  geom_boxplot() +
  theme(legend.position = 'none') +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  geom_hline(yintercept = mean(inun_1$mass_rem))
p2 <- ggplot(inun_1, aes(fTub, mass_rem, colour = fTub)) +
  geom_boxplot() +
  theme(legend.position = 'none',
        axis.text.x = element_blank()) +
  geom_hline(yintercept = mean(inun_1$mass_rem))
grid.arrange(p1, p2, nrow = 2)

```
clear variance among the residuals

# 3. Normality
histograms of residuals?
```{r, echo = F}
par(mfrow = c(2, 1), mar = c(5, 5, 2, 2), cex.lab = 1.5)
hist(inun_1$mass_rem)
hist(var_1$mass_rem)
```


# 4. Zeros in the data?
No...

# 5. Collinearity among covariates?
need the rest of the covariates for this

# 6. Relationships
```{r}
png('../output/ldmc_d.png')
plot(x = inun$LDMC,
     y = inun$mass_rem/inun$mass_init,
     pch = 16, cex = 0.5,
     ylab = "Mass Remaining",
     xlab = "LDMC")
dev.off()

png('../output/cn_d.png')
plot(x = inun$CN,
     y = inun$mass_rem/inun$mass_init,
     pch = 16, cex = 0.5,
     ylab = "Mass Remaining",
     xlab = "CN")
dev.off()

png('../output/sla_d.png')
plot(x = inun$SLA,
     y = inun$mass_rem/inun$mass_init,
     pch = 16, cex = 0.5,
     ylab = "Mass Remaining",
     xlab = "SLA")
dev.off()

png('../output/ldmc_cn.png')
plot(x = log(inun$LDMC),
     y = log(inun$CN),
     pch = 16, cex = 0.5,
     ylab = "CN",
     xlab = "LDMC")
dev.off()

png('../output/ldmc_sla.png')
plot(x = log(inun$LDMC),
     y = log(inun$SLA),
     pch = 16, cex = 0.5,
     ylab = "SLA",
     xlab = "LDMC")
dev.off()

png('../output/sla_cn.png')
plot(x = log(inun$SLA),
     y = log(inun$CN),
     pch = 16, cex = 0.5,
     ylab = "SLA",
     xlab = "CN")
dev.off()
```

# 7. Interactions?
yes, I think there will be an impact of LDMC on rate over time.
perhaps the impact of the trait will be different over time based on treatment
```{r, echo = F}
pairs(~mass_rem+days+mean_LDMC,data=inun_1,
      main="Simple Scatterplot Matrix")
pairs(~mass_rem+days+mean_LDMC,data=var_1,
      main="Simple Scatterplot Matrix")
```

# 8. Are observations of the response variable independent?
No. Two levels of random effect -- the tub and the species. These are nested.

# Modelling
```{r}
#MM1 <- glmer(Weight ~ offset(lInit) + days + mean_LDMC + (1 | fTub) + (days | fSpecies), family = poisson, data = inun_1)
```






