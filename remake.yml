
packages:
  - ade4
  - adephylo
  - ape
  - deconvolve
  - dplyr
  - grDevices
  - graphics
  - knitr
  - magrittr
  - minpack.lm
  - phytools
  - plyr
  - reshape2
  - stats
  - tools
  - utils
  - vegan
  - xtable

sources:
  - 'R/analyse_data.R'
  - 'R/figures.R'
  - 'R/load_data.R'
  - 'R/tables.R'

targets:
  all:
    depends:
      - figures
      - tables
      - manuscript.pdf
      
  figures:
    depends:
      - figs/boxplot.png
      - figs/fs_simulate.png
      - figs/pairplot.png
      - figs/phylo_all.png
      - figs/raw_pca.png
      - figs/tga_pure_samples.png
      - figs/tga_F.png
      - figs/tga_G.png
      - figs/raw_tga_three.png
      - figs/tga_TNVS.png
      - figs/theory_plot.png
      
  tables:
    depends:
      - figs/gen_bank_accessions.tex
      - figs/mantel_results.tex
      - figs/pca_loadings.tex
      - figs/tga_param_table.tex
      - figs/traits_table.tex

  # --------- data ------------------------
  
  species:
    command: load_species(species_data = "data-raw/species.csv")
    cleanup_level: purge
    check: exists
    
  carbon_nitrogen:
    command: load_leco_traits(leco_data = "data-raw/leco.csv")
    cleanup_level: purge
    check: exists
    
  economic_traits:
    command: load_les_traits(trait_data = "data-raw/traits.csv", 
                             species_data = species)
    cleanup_level: purge
    check: exists
    
  tga_output:
    command: tga_wrapper(species_data = species, 
                         function_name = I(tga_deconvolve), 
                         data_folder = 'data-raw/tga/')
    cleanup_level: purge
    check: exists
  
  biomass_traits: 
    command: load_tga_traits(tga_output)
    cleanup_level: purge
    check: exists
    
# ------- combine data -----------------
  
  combined_traits:
    command: traits_combine(species, carbon_nitrogen, economic_traits, biomass_traits)
    cleanup_level: purge
    check: exists
    
  mean_traits: 
    command: traits_mean_only(combined_traits, 
                              output_file = I("data/mean_traits.txt"))
  
  logged_trait_matrix:
    command: traits_log(mean_traits)
  
  pca_output:
    command: pca_data(logged_trait_matrix)
  
  phylo_tree:
    command: phylo_readtree("data-raw/phylo_tree.nwk")
    
  phylo_trts:
    command: phylo_traits(phylo_tree, mean_traits)
  
  raw_cl_sample:
    command: single_deconvolve("data-raw/raw_biomass/CL.csv")
  raw_lg_sample:
    command: single_deconvolve("data-raw/raw_biomass/LG.csv")
    
  
  # -------- figures -------------

  figs/theory_plot.png:
    plot: 
      width: 1500
      height: 480
    command: tga_theory_plots('data-raw/TGA/A_TGA.csv')
  
  figs/raw_tga_three.png:
    plot: 
      width: 1500
      height: 500
    command: tga_plot_three(tga_output, species, species_names = I(c('LL', 'MM', 'KK')))
  
  figs/tga_G.png:
    plot: 
      width: 1500
      height: 1940
    command: tga_plot_gram(tga_output, species, subfig = I('a'), gf = I('G'))
    
  figs/tga_F.png:
    plot: 
      width: 1500
      height: 1460
    command: tga_plot_forb(tga_output, species, subfig = I('b'), gf = I('F'))
  
  figs/tga_TNVS.png:
    plot: 
      width: 1500
      height: 980
    command: tga_plot_others(tga_output, species, subfigs = I(c('c', 'd', 'e')))

  figs/boxplot.png:
    plot: 
      width: 1200
      height: 950
    command: box_plot(mean_traits)
  
  figs/raw_pca.png:
    plot: 
      width: 1000
      height: 950
    command: pca(pca_output, logged_trait_matrix, species)
    
  figs/pairplot.png:
    plot: 
      width: 1500
      height: 1500
    command: pair_plot(logged_trait_matrix)
    
  figs/fs_simulate.png:
    plot: 
      width: 800
      height: 700
    command: simulate_fraser_suzuki()
  
  figs/tga_pure_samples.png:
    plot: 
      width: 1200
      height: 600
    command: tga_raw_plots(raw_cl_sample, raw_lg_sample)
  
  figs/phylo_all.png:
    plot: 
      width: 1500
      height: 1000
    command: phylo_plot(phylo_tree, phylo_trts)
  
  # --------- tables ---------
  figs/tga_param_table.tex:
    command: tga_param_table(tga_output, species, target_name)
  
  figs/traits_table.tex:
    command: traits_table(combined_traits, target_name)
  
  figs/gen_bank_accessions.tex:
    command: phylo_accessions("data-raw/GenBankAccessions.txt", target_name)
  
  figs/mantel_results.tex:
    command: phylo_mantel(phylo_tree, phylo_trts, target_name)
  
  figs/pca_loadings.tex:
    command: pca_loadings(pca_output, target_name)

  # ------ report ---------
  manuscript.tex:
    depends:
      - species
      - carbon_nitrogen
      - economic_traits
      - tga_output
      - biomass_traits
      - combined_traits
      - mean_traits
      - logged_trait_matrix
      - pca_output
      - phylo_tree
      - phylo_trts
      - raw_cl_sample
      - raw_lg_sample
    knitr: TRUE

  manuscript.pdf:
    command: texi2pdf("manuscript.tex", clean = TRUE)
    depends:
      - figures
      - tables
